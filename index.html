<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Attendance Scanner</title>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    video { width: 100%; max-width: 400px; border: 1px solid #ccc; }
    #log { margin-top: 20px; }
    .scanned { color: green; }
    .duplicate { color: red; }
  </style>
</head>
<body>
  <h1>QR Attendance Scanner</h1>
  <button id="startBtn">Start camera</button>
  <button id="stopBtn">Stop camera</button>
  <br><br>
  <video id="preview"></video>
  <div id="msg"></div>
  <div id="log"></div>

  <script>
    let codeReader;
    let scanned = {};
    let lastScanTime = 0;
    const cooldown = 3000; // 3 seconds

    const preview = document.getElementById('preview');
    const msg = document.getElementById('msg');
    const log = document.getElementById('log');

    function logScan(text, type){
      const div = document.createElement('div');
      div.textContent = new Date().toLocaleTimeString() + ' - ' + text;
      div.className = type;
      log.prepend(div);
    }

    function handleDetectedCode(text){
      const now = Date.now();
      if(now - lastScanTime < cooldown){
        return; // ignore scans during cooldown
      }
      lastScanTime = now;

      if(scanned[text]){
        msg.textContent = '⚠️ Already scanned: ' + text;
        logScan(text,'duplicate');
        alert('This QR code was already scanned before!');
      }else{
        scanned[text] = true;
        msg.textContent = '✅ New scan: ' + text;
        logScan(text,'scanned');
      }
    }

    document.getElementById('startBtn').onclick = async()=>{
      msg.textContent = '';
      if(!codeReader){ codeReader = new ZXingBrowser.BrowserMultiFormatReader(); }
      try{
        await codeReader.decodeFromVideoDevice(null, preview, (result,err)=>{
          if(result){ handleDetectedCode(result.getText()); }
        });
      }catch(e){ msg.textContent = 'Cannot start camera'; console.error(e); }
    };

    document.getElementById('stopBtn').onclick = ()=>{
      if(codeReader){ codeReader.reset(); msg.textContent='Camera stopped'; }
    };
  </script>
</body>
</html>
