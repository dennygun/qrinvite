<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Attendance Scanner</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; margin:0; padding:1rem; }
    h1 { font-size:1.5rem; margin-bottom:1rem; }
    button, select, label { margin:0.25rem 0; padding:0.5rem; border-radius:6px; border:none; }
    button { cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { border:1px solid #555; padding:0.5rem; word-break:break-word; }
    .controls { margin:0.5rem 0; display:flex; flex-wrap:wrap; gap:0.5rem; }
    .msg { margin-top:0.5rem; color:yellow; }
    #reader { width:100%; max-width:400px; }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>QR Attendance Scanner</h1>

  <div class="controls">
    <button id="startBtn">Start camera</button>
    <button id="stopBtn">Stop camera</button>
    <button id="exportBtn">Export CSV</button>
    <label style="background:#555; color:#fff; padding:0.5rem; cursor:pointer;">
      Import JSON<input type="file" id="importFile" accept="application/json" style="display:none">
    </label>
    <button id="clearBtn">Clear data</button>
  </div>
  <div class="msg" id="msg"></div>

  <div id="reader"></div>

  <div>
    <h3>Last scanned</h3>
    <div id="lastScan">No scans yet</div>
  </div>

  <div>
    <h3>Scanned codes summary</h3>
    <div style="max-height:300px; overflow:auto">
      <table id="scanTable">
        <thead>
          <tr><th>Code</th><th>First seen</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const msg = document.getElementById('msg');
    const lastScanDiv = document.getElementById('lastScan');
    const tableBody = document.querySelector('#scanTable tbody');

    let scans = JSON.parse(localStorage.getItem('qr_scans')||'{}');
    let html5QrCode = null;
    let lastScanTime = 0; // cooldown tracker

    function renderTable(){
      tableBody.innerHTML = '';
      Object.entries(scans).forEach(([code,e])=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${code}</td><td>${e.firstSeen}</td>`;
        tableBody.appendChild(tr);
      });
    }
    renderTable();

    function playBeep(times=1){
      try {
        let count = 0;
        function beepOnce(){
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();
          oscillator.type = "sine";
          oscillator.frequency.value = 800; 
          gainNode.gain.value = 0.1; 
          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);
          oscillator.start();
          oscillator.stop(ctx.currentTime + 0.2);
          count++;
          if(count < times){
            setTimeout(beepOnce, 300); // 0.3s between beeps
          }
        }
        beepOnce();
      } catch (e) {
        console.warn("Beep not supported:", e);
      }
    }

    function handleDetectedCode(text){
      const nowTime = Date.now();
      if(nowTime - lastScanTime < 3000){ 
        return; // ignore scans if within 3s cooldown
      }
      lastScanTime = nowTime;

      const now=new Date().toISOString();
      if(scans[text]){
        // Already scanned â†’ triple beep
        playBeep(3);
        alert("This QR code has already been scanned!");
        return;
      }
      scans[text]={firstSeen:now};
      localStorage.setItem('qr_scans',JSON.stringify(scans));
      lastScanDiv.innerHTML=`Code: ${text}<br>First: ${now}`;
      renderTable();
      playBeep(1); // single beep for new scans
    }

    document.getElementById('startBtn').onclick = async()=>{
      if(!html5QrCode){
        html5QrCode=new Html5Qrcode("reader");
      }
      try{
        await html5QrCode.start(
          { facingMode:"environment" },
          { fps:10, qrbox:250 },
          (decodedText)=>{ handleDetectedCode(decodedText); }
        );
        msg.textContent="Camera started";
      }catch(err){
        console.error(err);
        msg.textContent="Failed to start camera";
      }
    };

    document.getElementById('stopBtn').onclick = async()=>{
      if(html5QrCode){
        await html5QrCode.stop();
        msg.textContent="Camera stopped";
      }
    };

    document.getElementById('exportBtn').onclick = ()=>{
      const rows=["code,firstSeen"];
      for(const [code,e] of Object.entries(scans)){
        rows.push(`"${code}",${e.firstSeen}`);
      }
      const blob=new Blob([rows.join("\n")],{type:"text/csv"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;a.download="qr_scans.csv";a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('clearBtn').onclick = ()=>{
      if(confirm("Clear all data?")){
        scans={}; localStorage.removeItem('qr_scans'); renderTable(); lastScanDiv.textContent="No scans yet";
      }
    };

    document.getElementById('importFile').onchange = e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          scans=JSON.parse(ev.target.result);
          localStorage.setItem('qr_scans',JSON.stringify(scans));
          renderTable(); msg.textContent="Imported";
        }catch(err){ msg.textContent="Invalid JSON"; }
      };
      reader.readAsText(file);
    };
  </script>
</body>
</html>
